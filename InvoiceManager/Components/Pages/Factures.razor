@page "/factures"


@inject IFactureService FactureService
@inject ILogger<Factures> Logger
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>Factures - InvoiceManager</PageTitle>

<ErrorBoundary>
    <ChildContent>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Liste des Factures</h3>
            @if (!showForm)
            {
                <button class="btn btn-primary" @onclick="ShowCreateForm">
                    <i class="bi bi-plus-circle"></i> Nouvelle Facture
                </button>
            }
        </div>

        @if (showForm)
        {
            <div class="card mb-4">
                <div class="card-body">
                    <h4 class="card-title">@(selectedFacture == null ? "Nouvelle Facture" : $"Facture {selectedFacture.Numero}")</h4>
                    <FactureForm FactureToEdit="selectedFacture" OnSaved="HandleSaved" OnCancelled="HandleCancelled" />
                </div>
            </div>
        }

        @if (factures == null)
        {
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
                <p class="mt-2">Chargement des factures...</p>
            </div>
        }
        else if (!factures.Any())
        {
            <div class="alert alert-info">
                <p class="mb-0">Aucune facture trouvée. Cliquez sur "Nouvelle Facture" pour créer votre première facture.</p>
            </div>
        }
        else
        {
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Numéro</th>
                        <th>Statut</th>
                        <th>Client</th>
                        <th>Date</th>
                        <th class="text-end">Total HT</th>
                        <th class="text-end">Total TTC</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <Virtualize Items="@factures" Context="facture">
                        <tr class="@(facture.Statut == FactureStatut.Annulee ? "table-secondary" : "")">
                            <td><strong>@facture.Numero</strong></td>
                            <td>
                                <span class="badge @GetStatusBadgeClass(facture.Statut)">
                                    @GetStatusLabel(facture.Statut)
                                </span>
                            </td>
                            <td>@(facture.Client?.Nom ?? "N/A")</td>
                            <td>@facture.DateFacture.ToShortDateString()</td>
                            <td class="text-end">@facture.TotalHT.ToString("C")</td>
                            <td class="text-end"><strong>@facture.TotalTTC.ToString("C")</strong></td>
                            <td class="text-center">
                                <button type="button" 
                                        class="btn btn-sm @(facture.Statut == FactureStatut.Brouillon ? "btn-primary" : "btn-outline-secondary")" 
                                        @onclick="() => EditFacture(facture.Id)">
                                    @(facture.Statut == FactureStatut.Brouillon ? "Éditer" : "Consulter")
                                </button>
                            </td>
                        </tr>
                    </Virtualize>
                </tbody>
            </table>
        }
    </ChildContent>
    <ErrorContent Context="error">
        <div class="alert alert-danger">
            <h4>Une erreur s'est produite</h4>
            <p>@error.Message</p>
            <button class="btn btn-primary" @onclick="ReloadPage">Recharger</button>
        </div>
    </ErrorContent>
</ErrorBoundary>

@code {
    private List<Facture>? factures;
    private Facture? selectedFacture;
    private bool showForm = false;
    private bool shouldRender = true;

    protected override bool ShouldRender() => shouldRender;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Logger.LogInformation("Chargement de la page Factures");
            await LoadFactures();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement des factures");
            factures = new List<Facture>();
        }
    }

    private async Task LoadFactures()
    {
        shouldRender = true;
        factures = await FactureService.GetAllAsync();
        Logger.LogInformation("Chargement de {Count} factures", factures.Count);
    }

    private void ShowCreateForm()
    {
        shouldRender = true;
        selectedFacture = null;
        showForm = true;
    }

    private async Task EditFacture(int factureId)
    {
        try
        {
            shouldRender = true;
            selectedFacture = await FactureService.GetByIdAsync(factureId);
            showForm = true;
            Logger.LogInformation("Édition de la facture {FactureId}", factureId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de l'édition de la facture {FactureId}", factureId);
        }
    }

    private async Task HandleSaved()
    {
        try
        {
            shouldRender = true;
            await LoadFactures();
            showForm = false;
            selectedFacture = null;
            Logger.LogInformation("Facture sauvegardée avec succès");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de la sauvegarde de la facture");
        }
    }

    private void HandleCancelled()
    {
        shouldRender = true;
        showForm = false;
        selectedFacture = null;
    }

    private void ReloadPage()
    {
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }

    private string GetStatusBadgeClass(FactureStatut statut) => statut switch
    {
        FactureStatut.Brouillon => "bg-secondary",
        FactureStatut.Validee => "bg-success",
        FactureStatut.Annulee => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusLabel(FactureStatut statut) => statut switch
    {
        FactureStatut.Brouillon => "Brouillon",
        FactureStatut.Validee => "Validée",
        FactureStatut.Annulee => "Annulée",
        _ => statut.ToString()
    };

    public void Dispose()
    {
        Logger.LogDebug("Disposal de la page Factures");
        // Libération des ressources si nécessaire
    }
}
